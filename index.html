<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hist√≥ricas Decoloniais</title>
<style>

/* --- ESTILOS DE VISUALIZA√á√ÉO E ANIMA√á√ÉO --- */
.main-title {
  font-size: 28px;
  font-weight: bold;
  background: linear-gradient(90deg, #c59f9f, #f3b735, #17c0e6, #0edba5);
  color: #4b2e2e; /* marrom escuro */
  white-space: nowrap;
  overflow: hidden;
  border-right: 3px solid #a0522d; /* cursor marrom */
  width: 0;
  animation: typing 4s steps(50, end) forwards,
             blink 0.8s step-end infinite;
}

/* Digita√ß√£o */
@keyframes typing {
  from { width: 0; }
  to { width: 100%; }
}

/* Cursor piscando */
@keyframes blink {
  50% { border-color: transparent; }
}

.subtitle {
  text-align: center;
  font-size: 1.2rem;
  color: linear-gradient(90deg, #c59f9f, #f3b735, #17c0e6, #0edba5);
  max-width: 800px;
  margin: 0 auto 1rem auto;
  line-height: 1.5;
}

  :root {
  --bg:#fbf6f6; 
  --card:#d8d0d0; /* cor do fundo dos quadros - marrom claro (wheat) */
  --fg:#0b1220; 
  --muted:#556;
  --accent:#a0522d; /* j√° trocado para marrom */
}

 body{
  font-family: Arial, Helvetica, sans-serif;
  margin: 0;
  padding: 1rem;
  background: #dabbac;  /* marrom claro (tom tipo "tan") */
  color: var(--fg);
}

  h1,h2{ text-align:center; }
  .card{
    background:var(--card); border-radius:12px; padding:1rem;
    margin:1rem auto; max-width:900px; box-shadow:0 2px 8px rgba(0,0,0,0.1);
  }
  select,button{
    padding:0.5rem; margin:0.25rem 0; border-radius:6px; border:1px solid #6e6b6b;
    font-size:1rem;
  }
  button {
  background-color: #a0522d;  /* cor de fundo do bot√£o */
  color: #fff;               /* cor do texto */
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
}

button:hover {
  background-color: #8b4513; /* cor no hover */
}

  button:hover{ opacity:0.9; }
  button:disabled{
    background:#ccc; color:#666; cursor:not-allowed;
  }
  img{ max-width:100%; border-radius:8px; margin:0.5rem 0; }
  .audio-btn{ margin-right:0.5rem; }
  .compare-grid{
    display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
    gap:1rem; margin-top:1rem;
  }

  /* Estilos para a grava√ß√£o */
  .recording-status {
    margin: 10px 0;
    padding: 10px;
    border-radius: 6px;
    text-align: center;
    font-weight: bold;
  }
  .recording-active {
    background-color: #ffebee;
    color: #c62828;
    border: 1px solid #c62828;
  }
  .recording-saved {
    background-color: #e8f5e8;
    color: #2e7d32;
    border: 1px solid #2e7d32;
  }
</style>
</head>
<body>
<h1 class="main-title">Hist√≥rias em Vozes: Um Olhar Decolonial</h1>
<p class="subtitle">Agora vamos comparar as narrativas historicas, podemos dizer que a historia dos livros sempre tem raz√£o em rela√ß√£o aos eventos histr√≥ricos?</p>



<div class="card" aria-label="Sele√ß√£o e narrativa">
  <fieldset>
    <legend>Selecione evento e narrador</legend>
    <label for="eventoSelect">Evento:</label>
    <select id="eventoSelect" aria-label="Selecionar evento"></select><br>
    <label for="narradorSelect">Narrador:</label>
    <select id="narradorSelect" aria-label="Selecionar narrador"></select><br>
    <button id="showNarrative">Mostrar narrativa</button>
    <button id="resetView">Limpar</button>
    <button id="compareBtn">Comparar narrativas</button>
  </fieldset>

  <div id="narrativeArea">
    <h2>Narrativa</h2>
    <div id="narrativeText">Selecione um evento e um narrador, depois clique em "Mostrar narrativa".</div>
    <div id="eventImageContainer"></div>
    <div id="audioControls">
      <button id="playAudio" class="audio-btn">‚ñ∂Ô∏è Reproduzir √Åudio</button>
      <button id="stopAudio" class="audio-btn">‚èπÔ∏è Parar √Åudio</button>
      <button id="playAD" class="audio-btn" disabled>‚ôø Audiodescri√ß√£o (TTS)</button>
    </div>
  </div>

  <div id="comparisonArea"></div>
</div>

<div class="card">
  <h2>Conte-nos seu ponto de vista da hist√≥ria</h2>
  <p>Selecione um Evento. <strong>Ao parar a grava√ß√£o, o √°udio ser√° salvo automaticamente</strong> para o narrador <strong>"Estudante"</strong> neste evento.</p>
  
  <div id="recordingStatus" class="recording-status"></div>
  
  <button id="recStart">üî¥ Iniciar Grava√ß√£o</button>
  <button id="recStop" disabled>‚èπÔ∏è Parar e Salvar</button>
  <button id="recPlay" disabled>‚ñ∂Ô∏è Reproduzir Grava√ß√£o</button>
  <button id="recDelete" disabled>üóëÔ∏è Excluir Grava√ß√£o</button>
</div>


<script>
// =========================================================================
// --- CONFIGURA√á√ÉO DE √ÅUDIO E DADOS PERSONALIZADOS ---
// =========================================================================

// ‚ö†Ô∏è SUBSTITUA OS LINKS ABAIXO PELOS SEUS LINKS REAIS (Use URLs p√∫blicos como GitHub Pages)
const audioLinks = {
  // Use a chave do narrador e do evento para mapear o URL do seu MP3/OGG
  "Coloniza√ß√£o do Brasil (s√©culo XVI e XVII)": {
    "Cronista portugu√™s": "https://github.com/allineBrito/estudos_projetos/blob/main/audio/alne.ogg",
    "Ind√≠gena": "https://raw.githubusercontent.com/allineBrito/estudos_projetos/main/audio/regencias_indigena.ogg",
    "Africano escravizado": "https://raw.githubusercontent.com/allineBrito/estudos_projetos/main/audio/regencias_indigena.ogg",
    "Estudante": "", // Deixe em branco, pois este usa a grava√ß√£o local (localStorage)
  },
  "Per√≠odo das Revoltas Regenciais (1831 ‚Äì 1840)": {
    "Cronista portugu√™s": "https://[SEU_USUARIO].github.io/audio/regencias_cronista.ogg",
    "Ind√≠gena": "https://[SEU_USUARIO].github.io/audio/regencias_indigena.ogg",
    "Africano escravizado": "https://[SEU_USUARIO].github.io/audio/regencias_africano.ogg",
    "Estudante": "",
  },
  "Guerra de Canudos (1893 ‚Äì 1897)": {
    "Cronista portugu√™s": "https://[SEU_USUARIO].github.io/audio/canudos_cronista.ogg",
    "Ind√≠gena": "https://[SEU_USUARIO].github.io/audio/canudos_indigena.ogg",
    "Africano escravizado": "https://[SEU_USUARIO].github.io/audio/canudos_africano.ogg",
    "Estudante": "",
  } 
};

// --- Imagens de Perfil do Narrador ---
const imageMapping = {
  "Cronista portugu√™s": "https://via.placeholder.com/280x150?text=Cronista+Portugues", 
  "Ind√≠gena": "https://via.placeholder.com/280x150?text=Indigena",
  "Africano escravizado": "https://via.placeholder.com/280x150?text=Africano+Escravizado",
  "Estudante": "https://via.placeholder.com/280x150?text=Estudante"
};

// --- Imagens espec√≠ficas por Evento e Narrador ---
const eventImageMapping = {
  "Coloniza√ß√£o do Brasil (s√©culo XVI e XVII)": {
    "Cronista portugu√™s": "https://s1.static.brasilescola.uol.com.br/be/2024/09/revolucao-pernambucana.jpg",
    "Ind√≠gena": "https://www.omunicipio.jor.br/wordpress/wp-content/uploads/2024/04/01-8.jpg",
    "Africano escravizado": "https://ensinarhistoria.com.br/s21/wp-content/uploads/2015/06/07_Casa-de-negros_Rugendas.jpg",
  },
  "Per√≠odo das Revoltas Regenciais (1831 ‚Äì 1840)": {
    "Cronista portugu√™s": "https://static.preparaenem.com/2023/11/pintura-retratando-escravo-sendo-punido-em-um-pelourinho-em-alusao-a-revolta-dos-males.jpg",
    "Ind√≠gena": "https://www.pstu.org.br/wp-content/uploads/2019/01/cabanagem-capa-1122096.png",
    "Africano escravizado": "https://static.preparaenem.com/2023/11/pintura-retratando-escravo-sendo-punido-em-um-pelourinho-em-alusao-a-revolta-dos-males.jpg",
  },
  "Guerra de Canudos (1893 ‚Äì 1897)": {
    "Cronista portugu√™s": "https://biografiaresumida.com.br/wp-content/webp-express/webp-images/uploads/2019/01/Guerra-de-Canudos.jpg.webp",
    "Ind√≠gena": "https://bahia.ws/wp-content/uploads/2012/11/guerra_dos_canudos.jpg",
    "Africano escravizado": "https://static.wixstatic.com/media/02a26c_fac557e40b9840ad80c9419333af4344~mv2.jpg/v1/fill/w_568,h_320,al_c,q_80,usm_0.66_1.00_0.01,enc_avif,quality_auto/02a26c_fac557e40b9840ad80c9419333af4344~mv2.jpg",
  }
};

// --- Narrativas (O texto ainda √© necess√°rio para a exibi√ß√£o e Audiodescri√ß√£o) ---
const data = {
  "Coloniza√ß√£o do Brasil (s√©culo XVI e XVII)":{
    narrativas:{
      "Cronista portugu√™s":"Escutai, fi√©is s√∫ditos do Reino de Portugal! O que contemplamos no Brasil n√£o √© apenas terra distante; √© um novo e glorioso alicerce do nosso Imp√©rio. Nosso prop√≥sito √© a riqueza ‚Äî clara e inabal√°vel.",
      "Ind√≠gena":"Quando o ‚Äòpovo do mar‚Äô chegou, nossa vida mudou para sempre. Vieram como invasores, n√£o como amigos. Para eles, a floresta era mercadoria; para n√≥s, era m√£e.",
      "Africano escravizado":"Nossa hist√≥ria n√£o come√ßou no Brasil, mas nas terras que chamam de √Åfrica. Fomos arrancados de nossos reinos √† for√ßa. Nosso corpo pertencia ao senhor.",
      "Estudante":""
    },
    ad:{
      "Cronista portugu√™s":"Praia com embarca√ß√µes portuguesas chegando, soldados descendo armados.",
      "Ind√≠gena":"Praia vista pelos povos origin√°rios, com barcos imensos se aproximando.",
      "Africano escravizado":"Representa√ß√£o simb√≥lica do in√≠cio do tr√°fico de africanos escravizados.",
      "Estudante":""
    }
  },
  "Per√≠odo das Revoltas Regenciais (1831 ‚Äì 1840)":{
    narrativas:{
      "Cronista portugu√™s":"A ordem do Imp√©rio est√° sob ataque, e a unidade nacional corre grave perigo! O nosso dever √© manter o Brasil coeso, pr√≥spero e, acima de tudo, hier√°rquico.",
      "Ind√≠gena":"Chamam-nos ‚Äòcabanos‚Äô, ‚Äòselvagens‚Äô, ‚Äòdesordeiros‚Äô, mas somos os verdadeiros donos desta floresta e destas √°guas. Pegamos em armas por fome e por justi√ßa.",
      "Africano escravizado":"O que nos trouxeram foi a escravid√£o, mas n√£o conseguiram escravizar a nossa f√© e o nosso conhecimento. Vimos a fraqueza do governo. Lut√°vamos pela liberdade da alma.",
      "Estudante":""
    },
    ad:{
      "Cronista portugu√™s":"Gravura com repress√£o portuguesa ao levante dos Mal√™s.",
      "Ind√≠gena":"Vis√£o ind√≠gena da resist√™ncia negra na cidade de Salvador.",
      "Africano escravizado":"Imagem de africanos mu√ßulmanos escravizados vestidos de branco em rebeli√£o.",
      "Estudante":""
    }
  },
  "Guerra de Canudos (1893 ‚Äì 1897)":{
    narrativas:{
      "Cronista portugu√™s":"O que presenciamos em Canudos n√£o √© um levante popular, mas uma revolta de fan√°ticos contra a jovem Rep√∫blica. A vit√≥ria da Rep√∫blica √© inquestion√°vel.",
      "Ind√≠gena":"Chamaram nossa vida de 'fanatismo' e nosso arraial de 'covil de bandidos', mas Canudos era o nosso ref√∫gio. Lutamos at√© o √∫ltimo homem pela dignidade.",
      "Africano escravizado":"Naquele tempo de mudan√ßa de lei, a vida no sert√£o era dura para o liberto. Fomos para Canudos porque o Conselheiro n√£o olhava a cor. A guerra foi deles, mas a coragem foi nossa.",
      "Estudante":""
  },
    ad:{
      "Cronista portugu√™s":"Soldados da rep√∫blica marchando contra os rebeldes.",
      "Ind√≠gena":"Retrato de sertanejos e beatos em Canudos.",
      "Africano escravizado":"Imagem de Ant√¥nio Conselheiro e seus seguidores.",
      "Estudante":""
    }
  } 
  
};


// =========================================================================
// --- VARI√ÅVEIS E FUN√á√ïES DE INICIALIZA√á√ÉO ---
// =========================================================================

const eventoSelect=document.getElementById('eventoSelect');
const narradorSelect=document.getElementById('narradorSelect');
const narrativeText=document.getElementById('narrativeText');
const eventImageContainer=document.getElementById('eventImageContainer');
const playAudioBtn=document.getElementById('playAudio');
const stopAudioBtn=document.getElementById('stopAudio');
const playADBtn=document.getElementById('playAD');
const compareBtn=document.getElementById('compareBtn');
const comparisonArea=document.getElementById('comparisonArea');
const resetViewBtn=document.getElementById('resetView');

// Elementos de grava√ß√£o
const recStartBtn = document.getElementById('recStart');
const recStopBtn = document.getElementById('recStop');
const recPlayBtn = document.getElementById('recPlay');
const recDeleteBtn = document.getElementById('recDelete');
const recordingStatus = document.getElementById('recordingStatus');

// Preencher eventos
Object.keys(data).forEach(ev=>{
  let opt=document.createElement('option'); opt.value=ev; opt.textContent=ev;
  eventoSelect.appendChild(opt);
});

// Preencher narradores
function populateNarrators(){
  narradorSelect.innerHTML='';
  if(eventoSelect.value && data[eventoSelect.value]){
    Object.keys(data[eventoSelect.value].narrativas).forEach(n=>{
      let o=document.createElement('option'); o.value=n; o.textContent=n;
      narradorSelect.appendChild(o);
    });
  }
}
eventoSelect.addEventListener('change', populateNarrators);
populateNarrators();

// Resetar
resetViewBtn.addEventListener('click', ()=>{
  eventoSelect.selectedIndex=0;
  narradorSelect.innerHTML='';
  populateNarrators();
  narrativeText.textContent='Selecione um evento e um narrador, depois clique em "Mostrar narrativa".';
  eventImageContainer.innerHTML='';
  playADBtn.disabled=true;
  comparisonArea.innerHTML='';
  updateRecordingStatus('Nenhuma grava√ß√£o salva para este evento');
});

// Mostrar narrativa
document.getElementById('showNarrative').addEventListener('click', ()=>{
  const ev=eventoSelect.value, nar=narradorSelect.value;
  if(ev && nar){
    const audioUrl = audioLinks[ev] ? audioLinks[ev][nar] : null;

    if (nar === "Estudante" && hasRecordingForCurrentEvent()) {
      narrativeText.textContent = "üé§ Narrativa em √°udio dispon√≠vel (Grava√ß√£o local do Estudante) - clique em 'Reproduzir √Åudio'.";
    } else if (audioUrl) {
      narrativeText.textContent = `üé§ Narrativa dispon√≠vel (√Åudio customizado)`;
    } else {
      narrativeText.textContent = data[ev].narrativas[nar];
    }
    
    // L√≥gica da imagem
    const eventImgSrc = eventImageMapping[ev] ? eventImageMapping[ev][nar] : '';
    let imageToShow = '';
    let altText = '';

    if(eventImgSrc){
      imageToShow = eventImgSrc;
      altText = `Imagem do evento ${ev} na perspectiva de ${nar}`;
    } else {
      imageToShow = imageMapping[nar] || '';
      altText = `Imagem ilustrativa do narrador ${nar}`;
    }
    
    if (imageToShow) {
      eventImageContainer.innerHTML=`<img src="${imageToShow}" alt="${altText}">`;
    } else {
      eventImageContainer.innerHTML = '';
    }
    
    // O bot√£o AD usa TTS do texto da AD (Fallback)
    playADBtn.disabled = !data[ev].ad[nar];
    playADBtn.onclick = () => speakText(data[ev].ad[nar], nar, "pt-BR");
    
    comparisonArea.innerHTML = '';
  }
});

// Compara√ß√£o
compareBtn.addEventListener('click', ()=>{
  const ev=eventoSelect.value;
  if(!ev) return;
  const narrativas=data[ev].narrativas;
  const ads=data[ev].ad;
  comparisonArea.innerHTML="<h2>Compara√ß√£o de Narrativas</h2>";
  const container=document.createElement('div');
  container.className="compare-grid";
  
  Object.keys(narrativas).forEach(n=>{
    const div=document.createElement('div');
    div.className="card";
    
    const compareImgSrc = eventImageMapping[ev] && eventImageMapping[ev][n] ? eventImageMapping[ev][n] : imageMapping[n];
    const altText = `Imagem do evento ${ev} na perspectiva de ${n}`;

    let textoNarrativa = narrativas[n];
    let playAction = '';
    const audioUrl = audioLinks[ev] ? audioLinks[ev][n] : null;

    // Prioridade 1: Grava√ß√£o do Estudante (localStorage)
    if (n === "Estudante" && hasRecordingForCurrentEvent()) {
      textoNarrativa = "üé§ Narrativa em √°udio (grava√ß√£o do estudante)";
      playAction = `
        const savedKey = 'recording_' + '${ev}'.replace(/\\s+/g, '_');
        const savedData = localStorage.getItem(savedKey);
        if (savedData) {
          const uint8Array = new Uint8Array(JSON.parse(savedData));
          const blob = new Blob([uint8Array], { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url);
          speechSynthesis.cancel();
          audio.play().catch(e => console.error("Erro ao reproduzir grava√ß√£o na compara√ß√£o:", e));
        }
      `;
    // Prioridade 2: √Åudio Customizado (URL externo)
    } else if (audioUrl) {
      textoNarrativa = "üé§ Narrativa dispon√≠vel (√Åudio customizado)";
      playAction = `playCustomAudio('${audioUrl}')`;
    // Prioridade 3: TTS (Texto da narrativa, se n√£o houver √°udio customizado)
    } else {
      // Se n√£o houver √°udio customizado, usamos o texto original com TTS (como um √∫ltimo fallback)
      playAction = `speakText(${JSON.stringify(textoNarrativa)}, ${JSON.stringify(n)}, "pt-BR")`;
    }

    const adText = ads[n];
    
    div.innerHTML=      `<h3>${n}</h3>
      <p>${textoNarrativa}</p>
      <img src="${compareImgSrc}" alt="${altText}">
      <button onclick='${playAction}'>‚ñ∂Ô∏è √Åudio</button>
      <button onclick='speakText(${JSON.stringify(adText)}, ${JSON.stringify(n)}, "pt-BR")'>‚ôø Audiodescri√ß√£o (TTS)</button>`;
      
    container.appendChild(div);
  });
  comparisonArea.appendChild(container);
});


// =========================================================================
// --- L√ìGICA DE √ÅUDIO (Foco em √Åudio Personalizado e Grava√ß√£o) ---
// =========================================================================

let currentAudio = null; // Vari√°vel global para controlar a reprodu√ß√£o de √°udio/grava√ß√£o

// --- TTS (Apenas para Fallback/Audiodescri√ß√£o) ---
let voices=[];
function loadVoices(){ 
    voices=speechSynthesis.getVoices();
    checkSavedRecording();
}
speechSynthesis.onvoiceschanged=loadVoices;
loadVoices();

// Fun√ß√£o que reproduz o √Åudio Customizado via URL
function playCustomAudio(url) {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
    }
    speechSynthesis.cancel();
    
    currentAudio = new Audio(url);
    currentAudio.play().catch(error => {
        console.error("Erro ao reproduzir √°udio customizado. Verifique o link e CORS:", error);
        alert("Erro ao reproduzir √°udio. Verifique se o link est√° correto e se o servidor permite acesso (CORS).");
    });
}

// Manter a fun√ß√£o TTS para Audiodescri√ß√£o (AD) e o Fallback
function getTTSVoice(narratorKey) {
  // Retorna a primeira voz pt-BR dispon√≠vel
  const ptBRVoices = voices.filter(v => v.lang.startsWith('pt-BR') || v.lang.startsWith('pt-br'));
  const betterVoice = ptBRVoices.find(v => v.name.includes('Google') || v.name.includes('Microsoft'));
  return betterVoice || ptBRVoices[0] || null;
}

function speakText(text, narratorKey, lang){
  speechSynthesis.cancel();
  if (!text) return;
  
  // Par√¢metros de suaviza√ß√£o para o TTS de AD
  const voiceParams = {
    "default": { rate: 1.0, pitch: 1.0 }
  };
  const params = voiceParams['default'];

  const u=new SpeechSynthesisUtterance(text);
  u.lang=lang;
  u.voice=getTTSVoice(narratorKey);
  
  u.rate = params.rate;
  u.pitch = params.pitch;
  
  speechSynthesis.speak(u);
}


// L√≥gica de reprodu√ß√£o do bot√£o principal (prioriza √°udio customizado/grava√ß√£o)
playAudioBtn.addEventListener('click', ()=>{
  const ev = eventoSelect.value;
  const nar = narradorSelect.value;
  
  // Parar o √°udio anterior (seja TTS ou grava√ß√£o)
  if (currentAudio) {
    currentAudio.pause();
    currentAudio.currentTime = 0;
    currentAudio = null;
  }
  speechSynthesis.cancel(); 

  const audioUrl = audioLinks[ev] ? audioLinks[ev][nar] : null;

  // 1. Prioriza Grava√ß√£o do Estudante (localStorage)
  if (nar === "Estudante" && hasRecordingForCurrentEvent()) {
    const recordingURL = getRecordingForCurrentEvent();
    if (recordingURL) {
        currentAudio = new Audio(recordingURL);
        currentAudio.play().catch(error => {
          console.error("Erro ao reproduzir grava√ß√£o:", error);
          updateRecordingStatus("‚ùå Erro ao reproduzir grava√ß√£o");
        });
    }
    return;
  }
  
  // 2. Tenta √Åudio Customizado (URL)
  if (audioUrl) {
    playCustomAudio(audioUrl);
    return;
  }
  
  // 3. Fallback: TTS (s√≥ se n√£o houver √°udio customizado ou for o Estudante sem grava√ß√£o)
  if (ev && nar) {
    const textToSpeak = data[ev].narrativas[nar];
    speakText(textToSpeak, nar, "pt-BR");
  }
});

stopAudioBtn.addEventListener('click', ()=>{
  speechSynthesis.cancel(); // Para o TTS
  if(currentAudio){
    currentAudio.pause();
    currentAudio.currentTime = 0;
    currentAudio = null;
  }
});


// =========================================================================
// --- L√ìGICA DE GRAVA√á√ÉO E SALVAMENTO (localStorage) ---
// =========================================================================

let mediaRecorder = null;
let audioChunks = [];
let audioStream = null;

// Fun√ß√£o para atualizar o status da grava√ß√£o
function updateRecordingStatus(message, type = '') {
  recordingStatus.textContent = message;
  recordingStatus.className = 'recording-status';
  if (type) {
    recordingStatus.classList.add(type);
  }
}

// Fun√ß√£o para verificar se h√° grava√ß√£o para o evento atual
function hasRecordingForCurrentEvent() {
  if (!eventoSelect.value) return false;
  const eventKey = `recording_${eventoSelect.value.replace(/\s+/g, '_')}`;
  return localStorage.getItem(eventKey) !== null;
}

// Fun√ß√£o para obter a grava√ß√£o do evento atual
function getRecordingForCurrentEvent() {
  if (!eventoSelect.value) return null;
  const eventKey = `recording_${eventoSelect.value.replace(/\s+/g, '_')}`;
  const savedRecording = localStorage.getItem(eventKey);
  if (savedRecording) {
    try {
      const uint8Array = new Uint8Array(JSON.parse(savedRecording));
      const blob = new Blob([uint8Array], { type: 'audio/webm' });
      return URL.createObjectURL(blob);
    } catch (e) {
      console.error("Erro ao carregar grava√ß√£o do localStorage:", e);
      return null;
    }
  }
  return null;
}

// Fun√ß√£o para salvar a grava√ß√£o no localStorage
function saveRecording(blob) {
  const reader = new FileReader();
  reader.onload = function() {
    const arrayBuffer = this.result;
    const uint8Array = new Uint8Array(arrayBuffer);
    
    const eventKey = `recording_${eventoSelect.value.replace(/\s+/g, '_')}`;
    localStorage.setItem(eventKey, JSON.stringify(Array.from(uint8Array)));
    
    updateRecordingStatus('‚úÖ Grava√ß√£o salva com sucesso!', 'recording-saved');
    recPlayBtn.disabled = false;
    recDeleteBtn.disabled = false;
    
    if (narradorSelect.value === "Estudante") {
      document.getElementById('showNarrative').click();
    }
  };
  reader.onerror = function() {
      updateRecordingStatus('‚ùå Erro ao salvar grava√ß√£o', 'recording-active');
  };
  reader.readAsArrayBuffer(blob);
}

// Fun√ß√£o para excluir grava√ß√£o
function deleteRecording() {
  if (!eventoSelect.value) return;
  const eventKey = `recording_${eventoSelect.value.replace(/\s+/g, '_')}`;
  localStorage.removeItem(eventKey);
  
  updateRecordingStatus('Grava√ß√£o exclu√≠da');
  recPlayBtn.disabled = true;
  recDeleteBtn.disabled = true;
  
  if (narradorSelect.value === "Estudante") {
    document.getElementById('showNarrative').click();
  }
}

// Verificar se h√° grava√ß√£o salva para o evento atual
function checkSavedRecording() {
  if (hasRecordingForCurrentEvent()) {
    recPlayBtn.disabled = false;
    recDeleteBtn.disabled = false;
    updateRecordingStatus('Grava√ß√£o dispon√≠vel para este evento');
  } else {
    recPlayBtn.disabled = true;
    recDeleteBtn.disabled = true;
    updateRecordingStatus('Nenhuma grava√ß√£o salva para este evento');
  }
}

// Event Listeners para grava√ß√£o
recStartBtn.addEventListener('click', async () => {
  if (!eventoSelect.value) {
    updateRecordingStatus('‚ùå Selecione um evento primeiro');
    return;
  }

  try {
    audioStream = await navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      } 
    });

    mediaRecorder = new MediaRecorder(audioStream, {
      mimeType: 'audio/webm;codecs=opus'
    });

    audioChunks = [];

    mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        audioChunks.push(event.data);
      }
    };

    mediaRecorder.onstop = () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      saveRecording(audioBlob);
      
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
        audioStream = null;
      }
    };

    mediaRecorder.onerror = (event) => {
      console.error('Erro na grava√ß√£o:', event.error);
      updateRecordingStatus('‚ùå Erro na grava√ß√£o');
      
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
        audioStream = null;
      }
      recStartBtn.disabled = false;
      recStopBtn.disabled = true;
    };

    mediaRecorder.start();
    recStartBtn.disabled = true;
    recStopBtn.disabled = false;
    recPlayBtn.disabled = true;
    recDeleteBtn.disabled = true;
    updateRecordingStatus('üî¥ Gravando...', 'recording-active');

  } catch (error) {
    console.error('Erro ao acessar microfone:', error);
    updateRecordingStatus('‚ùå N√£o foi poss√≠vel acessar o microfone');
    recStartBtn.disabled = true;
    recStopBtn.disabled = true;
  }
});

recStopBtn.addEventListener('click', () => {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    recStartBtn.disabled = false;
    recStopBtn.disabled = true;
  }
});

recPlayBtn.addEventListener('click', () => {
  const recordingURL = getRecordingForCurrentEvent();
  if (recordingURL) {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
      currentAudio = null;
    }
    speechSynthesis.cancel();
    
    currentAudio = new Audio(recordingURL);
    currentAudio.play().catch(error => {
      console.error('Erro ao reproduzir √°udio:', error);
      updateRecordingStatus('‚ùå Erro ao reproduzir grava√ß√£o');
    });
  }
});

recDeleteBtn.addEventListener('click', deleteRecording);
eventoSelect.addEventListener('change', checkSavedRecording);

checkSavedRecording(); 
</script>
</body>
</html>
