<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador de Narrativas HistÃ³ricas Decoloniais (voz e gravaÃ§Ã£o corrigidas)</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --fg:#0b1220; --muted:#556;
    --accent:#0066ff; --radius:16px;
  }
  body{
    font-family:system-ui, sans-serif;
    background:var(--bg);
    color:var(--fg);
    margin:0; padding:2rem;
  }
  h1{font-size:1.6rem;}
  select, button{
    font-size:1rem;
    margin:4px;
    padding:8px 12px;
    border-radius:var(--radius);
    border:1px solid #ccc;
  }
  button{background:var(--accent); color:white; border:none;}
  button:disabled{background:#ccc;}
  .card{
    background:var(--card);
    padding:1rem;
    border-radius:var(--radius);
    box-shadow:0 2px 6px rgba(0,0,0,.1);
    margin-bottom:1rem;
  }
  #recordingStatus{margin-top:.5rem;font-weight:bold;}
</style>
</head>
<body>

<h1>Simulador de Narrativas HistÃ³ricas Decoloniais</h1>

<div class="card">
  <label>Evento histÃ³rico:</label>
  <select id="eventoSelect">
    <option value="">-- selecione --</option>
    <option>Chegada dos Portugueses (1500)</option>
    <option>ResistÃªncia IndÃ­gena</option>
    <option>TrÃ¡fico AtlÃ¢ntico</option>
  </select>
  <br>
  <label>Narrador:</label>
  <select id="narradorSelect">
    <option value="">-- selecione --</option>
    <option value="Cronista portuguÃªs">Cronista portuguÃªs</option>
    <option value="IndÃ­gena">IndÃ­gena</option>
    <option value="Africano escravizado">Africano escravizado</option>
  </select>
  <br>
  <textarea id="texto" rows="4" cols="60" placeholder="Digite o texto que serÃ¡ narrado..."></textarea><br>
  <button id="btnNarrar">ğŸ”Š Narrar</button>
</div>

<div class="card">
  <h3>ğŸ™ï¸ GravaÃ§Ã£o do estudante</h3>
  <button id="recStartBtn">âºï¸ Iniciar gravaÃ§Ã£o</button>
  <button id="recStopBtn" disabled>â¹ï¸ Parar</button>
  <button id="recPlayBtn" disabled>â–¶ï¸ Ouvir</button>
  <button id="recDeleteBtn" disabled>ğŸ—‘ï¸ Apagar</button>
  <div id="recordingStatus"></div>
</div>

<script>
// ===================== CONFIGURAÃ‡ÃƒO DE VOZES =====================
let voiceMapping = {};

function loadVoices() {
  const voices = speechSynthesis.getVoices();
  const ptVoices = voices.filter(v => v.lang.includes('pt'));

  // tenta encontrar vozes adequadas
  const male1 = ptVoices.find(v => /Ricardo|Felipe|JoÃ£o|male/i.test(v.name)) || ptVoices[0];
  const male2 = ptVoices.find(v => v !== male1 && /Daniel|Luiz|male/i.test(v.name)) || ptVoices[1];
  const female = ptVoices.find(v => /Luciana|Camila|VitÃ³ria|female/i.test(v.name)) || ptVoices[2];

  voiceMapping = {
    "Cronista portuguÃªs": male1,
    "Africano escravizado": male2,
    "IndÃ­gena": female
  };
}
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function speakText(text, narrator) {
  if (!text.trim()) return;
  if (!voiceMapping[narrator]) {
    alert("Voz nÃ£o carregada ainda. Aguarde um segundo e tente novamente.");
    return;
  }
  const utter = new SpeechSynthesisUtterance(text);
  utter.voice = voiceMapping[narrator];
  utter.lang = "pt-BR";
  utter.rate = 1;
  utter.pitch = 1;
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

document.getElementById("btnNarrar").addEventListener("click", () => {
  const narrador = document.getElementById("narradorSelect").value;
  const texto = document.getElementById("texto").value;
  if (!narrador) { alert("Selecione um narrador."); return; }
  speakText(texto, narrador);
});

// ===================== SISTEMA DE GRAVAÃ‡ÃƒO =====================
let mediaRecorder, audioChunks = [], audioStream;

const recStartBtn = document.getElementById("recStartBtn");
const recStopBtn = document.getElementById("recStopBtn");
const recPlayBtn = document.getElementById("recPlayBtn");
const recDeleteBtn = document.getElementById("recDeleteBtn");
const recordingStatus = document.getElementById("recordingStatus");
const eventoSelect = document.getElementById("eventoSelect");

function updateRecordingStatus(msg) {
  recordingStatus.textContent = msg;
}

function saveRecording(blob) {
  const reader = new FileReader();
  reader.onload = function() {
    const arrayBuffer = this.result;
    const uint8Array = new Uint8Array(arrayBuffer);
    const eventKey = `recording_${eventoSelect.value.replace(/\s+/g, '_')}`;
    localStorage.setItem(eventKey, JSON.stringify(Array.from(uint8Array)));
    updateRecordingStatus("âœ… GravaÃ§Ã£o salva com sucesso!");
    recPlayBtn.disabled = false;
    recDeleteBtn.disabled = false;
  };
  reader.readAsArrayBuffer(blob);
}

recStartBtn.addEventListener("click", async () => {
  if (!eventoSelect.value) {
    alert("Selecione um evento antes de gravar.");
    return;
  }
  try {
    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(audioStream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks, { type: "audio/webm" });
      saveRecording(blob);
      audioStream.getTracks().forEach(t => t.stop());
    };
    mediaRecorder.start();
    updateRecordingStatus("ğŸ™ï¸ Gravando... fale agora!");
    recStartBtn.disabled = true;
    recStopBtn.disabled = false;
  } catch (err) {
    console.error("Erro ao gravar:", err);
    updateRecordingStatus("âŒ Erro ao acessar microfone.");
  }
});

recStopBtn.addEventListener("click", () => {
  if (mediaRecorder && mediaRecorder.state !== "inactive") {
    mediaRecorder.stop();
    updateRecordingStatus("ğŸ’¾ Salvando gravaÃ§Ã£o...");
    recStartBtn.disabled = false;
    recStopBtn.disabled = true;
  }
});

recPlayBtn.addEventListener("click", () => {
  const eventKey = `recording_${eventoSelect.value.replace(/\s+/g, '_')}`;
  const stored = localStorage.getItem(eventKey);
  if (!stored) { updateRecordingStatus("âš ï¸ Nenhuma gravaÃ§Ã£o encontrada."); return; }
  const uint8Array = new Uint8Array(JSON.parse(stored));
  const blob = new Blob([uint8Array], { type: "audio/webm" });
  const audioURL = URL.createObjectURL(blob);
  const audio = new Audio(audioURL);
  audio.play()
    .then(() => updateRecordingStatus("â–¶ï¸ Reproduzindo gravaÃ§Ã£o..."))
    .catch(() => updateRecordingStatus("âŒ Erro ao reproduzir Ã¡udio."));
});

recDeleteBtn.addEventListener("click", () => {
  const eventKey = `recording_${eventoSelect.value.replace(/\s+/g, '_')}`;
  localStorage.removeItem(eventKey);
  recPlayBtn.disabled = true;
  recDeleteBtn.disabled = true;
  updateRecordingStatus("ğŸ—‘ï¸ GravaÃ§Ã£o excluÃ­da.");
});
</script>
</body>
</html>
